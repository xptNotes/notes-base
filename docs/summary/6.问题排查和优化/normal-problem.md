

# 常见优化问题

# 一、接口变慢问题

## 如何排查慢接口原因?

定位问题:

- trace工具
- 如果没有APM trace平台, 生产环境安装arthas ,利用trace接口,定位那一块.



解决方法:

- 扩容
  - 应用扩容: 应用cpu和内存变高
  - redis扩容、Mysql扩容、Kafka扩容
- 重启
- 代码逻辑修改



## 如何优化?

### 数据库慢

导致数据库查询变慢的原因:

- 未加索引
- 索引失效
  - 
- 小表驱动大表
- SQL不能太复杂,检查子查询
- 返回数据量太大
- 单表数据量太大,考虑分片或者其他存储



### 调用第三方接口慢

- 设置合理超时时间,参考对方线上P95时间和自身接口要求
- 集成限流、熔断框架,防止对方接口拖垮自身接口
- 事务性接口,需要考虑重试补偿逻辑
- 循环调用,改成单次批量调用
- 缓存查询接口(考虑是否存在缓存穿透、缓存利用率低)



### 中间件访问慢

- redis慢: 大key问题、热key,

  - 大key问题,进行拆分
  - 热key,进行本地缓存

- kafka慢

  - 生产端:

  - 消费端: 扩分区,增加消费节点、消费线程或者批量消费,批量写库

    

### 程序逻辑

- 非法校验逻辑前置,避免无用数据穿透消耗系统资源,减少无用调用
- 循环调用改成单次批量调用
- 同步改异步
- 非核心逻辑剥离
- 线程池设置(千万不要创建无界队列线程池,线程池满了,要写拒绝策略)
- 锁合理设置(锁粒度)
- 优化gc参数(YGC、Full GC是否太频繁)
- 日志打印是否合理,日志同步/异步 ,日志输出也有可能导致阻塞



### 架构优化

- 高并发读逻辑都走redis,尽可能不穿透到db
- 涉及写逻辑: 异步、批量处理、分库分表
- 接口接入限流熔断,sentinel或hystrix
- 监控告警(error日志、接口慢查询或不可用或限流熔断告警、DB告警、中间件告警、应用系统告警)
- 接口动态配置开关,切断流量和非核心业务调用
- 设计自动对账job,保证数据自动可修复







# 二、索引失效问题

常见innodb索引失效原因:

- 未遵循最左前缀原则
- 使用了函数或者表达式
- MySQL隐式类型转换,索引列类型和查询条件中的数据类型不匹配
- OR条件使用不当
  - 查询条件中使用了`OR`，且`OR`两边的条件中有一个未使用索引。如果`OR`条件中有一个列没有索引，MySQL可能会放弃使用索引。
- like 匹配结尾或者中间,非匹配前缀
- is null 或者 is not null
  - MySQL无法利用索引快速定位`NULL`值。
- 数据分布不均匀
  - 索引列的值分布不均匀，导致优化器认为全表扫描比索引扫描更高效。如当前列的值重复率过高
- 索引列参与计算



排查索引失效工具:

- 慢sql查询日志监控
- Explain 分析





# 三、spring 事务失效问题

常见事务失效场景:

- 方法自调用
- 异常被捕获,未抛出
- 异常rollback配置错误,未能正确捕获,应该全部会滚,结果已经执行的未会滚
- 方法非public
- 非运行时异常,默认情况只会捕获RuntimeException
- 不是Spring Bean
- 数据库不支持事务
- 传播机制配置错误
- 未启用事务管理或者多数据源未正确配置事务管理器











