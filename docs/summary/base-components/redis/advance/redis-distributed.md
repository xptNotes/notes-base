---
title: Redis分布式解决方案
category: Redis
tag:
  - Redis集群
head:
  - - meta
    - name: keywords
      content: redis,sentinel,redis-cluster
  - - meta
    - name: description
      content: redis集群方案总结，希望对你有帮助！
---

# 一、Redis复制原理

Redis的复制功能包括数据同步(sync)和命令传播(command propagate)两个操作



## 数据同步-sync和psync命令



### sync命令执行流程

- 从服务器向主服务器发送 sync命令
- 主服务器收到sync命令,开始执行bgsave命令,生成rdb文件,并使用一个缓冲区记录从现在开始执行的所有写命令
- 当主服务器bgsave命令执行完毕后,将rdb文件发送给从服务器,从服务器接收并载入rdb文件,将自己的数据库状态更新至主服务器执行bgsave命令时的数据库状态
- 主服务器将记录在缓冲区里面的所有命令发送给从服务器,从服务器执行这些命令,将自己的数据库状态更新至主服务器数据库当前所处的状态
- 同步完成后,将执行命令转播流程,主服务器执行完写请求,发送到从服务器

sync命令是2.8版本之前的同步方式.

sync执行的时机:

- 初次复制: 从服务器以前没有复制过主服务器
- 断线后重新复制:因为网络问题,从服务器和主服务器短时间断开,然后重新连接,复制主服务器数据.

存在问题:

- 断开重连后,可能不需要同步太多数据,却生成了RDB,全量同步,浪费资源.

### psync命令

2.8版本之后,开始支持psync命令

#### psync命令基础

psync命令包括: 全量同步 和 部分同步

- 全量同步:用于处理初次复制的状况,执行步骤与sync相同
- 部分同步:处理断线后重复复制的情况,当从服务器在断线后重新连接主服务器时,如果条件允许,主服务器可以将主从服务器连接断开期间执行的命令发送给从服务器,从服务器只要接收并执行这些写命令,就可以将数据库更新至主服务器当前所处的状态

部分同步的数据结构:

- 主服务器的复制偏移量(replication offset) 和 从服务器的复制偏移量
- 主服务器的复制积压缓冲区(replication backlog)
- 服务器的运行id (run ID)

**复制偏移量:**

- 主服务器每次向从服务器传播N个字节的数据时,将自己的复制偏移量的加上N
- 从服务器每次收到主服务器传播来的N个字节的数据时,就将复制偏移量的值加上N

**复制积压缓冲区**

- 是一个固定长度的,先进先出的队列
- 为每个字节记录相应的复制偏移量

**复制积压缓冲区的大小设置**

- 复制积压缓冲区大小默认为1mb
- 为了安全起见,可以设置为: 2 * second * wrtie_size_per_second
  - second : 主从断线重连时间
  - wrtie_size_per_second : 每秒主服务器的写请求大小

**服务器运行ID**

- 主从服务器在运行时都会有自己的运行id
- 运行ID在服务器启动时自动生成,有40个随机的十六进制组成
- 从服务器在重启后,会向之前连接的主服务器发送之前保存的运行ID



#### psync命令实现

```
psync <runid> <offset>
```

**psync命令工作流程**
完整复制-网络中断-重复复制
从服务器: 127.0.0.1 6378 ,主服务器: 127.0.0.1 6379

1. 客户端向服务器 6378 发送命令, slaveof 127.0.0.1 6379
2. 6378 从服务器 会向 6379 主服务器发送 psync ? -1 命令
3. 主服务器收到后,执行bgsave ,生成rdb文件
4. 主服务器向 从服务器返回 +FULLRESYNC 主服务器运行ID 当前复制偏移量比如10001
5. rdb生成完成后,主服务器发送给从服务器,从服务器加载数据
6. 主服务器将复制缓冲区数据发送给从服务器执行,两者达到一致状态
7. 运行一段时间后,两者偏移量相同,假如都为20000
8. 从服务器断开
9. 从服务器重新连接主服务器,并进行对主服务器复制,发送请求: psync 之前保存的主服务器运行ID 20000
10. 主服务器收到请求后,校验运行id,如果相同,再校验 当前收到的offset是否在复制积压缓冲区内如果存在,则向从服务器返回+continue 表示将于从服务器执行部分同步操作,否则校验失败,将执行全量同步
11. 部分同步操作后,主从再次回到一致状态



存在问题:主从切换后如何解决?



#### psync2.0方案

Redis4.0版本,给出pysnc2.0版本,优化了,在redis 主从切换后,runid和offset变化,导致全量同步数据的问题,使得在主从切换之后,从服务器仍然可以继续增量同步.

如何实现:

psync2.0版本抛弃了服务器运行ID，采用了replid和replid2来代替，其中replid存储的是当前主服务器的运行ID，replid2保存的是上一个主服务器运行ID。

- 复制偏移量（replication offset）
- 积压缓冲区（replication backlog）
- 主服务器运行id（replid）
- 上个主服务器运行id（replid2）

通过replid和replid2我们可以解决主服务器切换时，增量同步的问题：

- 如果replid等于当前主服务器的运行id，那么判断同步方式增量/全量同步
- 如果replid不相等，则判断replid2是否相等（是否同属于上一个主服务器的从服务器），如果相等，仍然可以选择增量/全量同步，如果不相等则只能进行全量同步。



# 二、Redis哨兵集群





## 哨兵工作原理

哨兵工作原理如下:

- 每个哨兵节点每10秒会向主节点和从节点发送info命令,获取最新的主从结构,在配置时,可以只配置监视主节点,有主节点获取从节点信息
- 每隔哨兵节点每2秒会向Redis数据节点指定频道上发送该哨兵节点对于主节点的判断以及当前哨兵的信息.同时每个哨兵也会订阅该频道来获取其他哨兵的判断信息和哨兵节点信息,其就是通过pub/sub来完成
- 每隔1秒,哨兵会向主节点、从节点、其他哨兵发送ping做心跳检测, 这也是哨兵判断其他节点是否正常的依据



## 故障发现和转移

### 主观下线和客观下线





### 故障转移处理









# 三、Redis Cluster







优秀博客:

[Redis综述篇：与面试官彻夜长谈Redis缓存、持久化、淘汰机制、哨兵、集群底层原理！](https://juejin.cn/post/7097521572885299214?searchId=2025031723472888A242785CE0360F882F#heading-16)



